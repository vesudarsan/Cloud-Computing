<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Drone Flight Stats & Devices</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b1020; --card:#121a33; --text:#e9ecf1; --muted:#9aa4b2; --accent:#6ea8fe; --ok:#3ecf8e; --warn:#f6c64b; --crit:#ff5f5f; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0a0f1f,#0d1530);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1100px;margin:36px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 16px}
    .card{background:var(--card);border:1px solid #1e2a52;border-radius:14px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    .row{display:grid;gap:12px}
    @media(min-width:980px){.row{grid-template-columns:repeat(4,1fr)}}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #273459;background:#0f1630;color:var(--text)}
    button{cursor:pointer;background:linear-gradient(180deg,#1e2d66,#1a2660);border:1px solid #2b3e7a}
    button:hover{filter:brightness(1.05)}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-top:16px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .stat{background:#0f1630;border:1px solid #223064;border-radius:12px;padding:16px;display:flex;flex-direction:column;gap:8px}
    .stat .label{color:var(--muted);font-size:12px;letter-spacing:.4px;text-transform:uppercase}
    .stat .value{font-size:28px;font-weight:700}
    .muted{color:var(--muted);font-size:12px}
    .err{color:#ff8383}
    .footer{margin-top:18px;color:var(--muted);font-size:12px}
    .flex{display:flex;gap:10px;align-items:end}
    .list{margin-top:12px;border-top:1px solid #243366}
    .item{display:grid;grid-template-columns:140px 110px 1fr;gap:10px;padding:10px 0;border-bottom:1px dashed #223064;align-items:center}
    .kv{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; color:#cfd5e6}
    .pill{display:inline-block;padding:2px 6px;border-radius:8px;border:1px solid #2a3a74;background:#0c1430;color:#9fb2ff;font-size:11px;margin-left:6px}
    .devices{max-height:280px;overflow:auto;padding-top:8px}
    .dev-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px dashed #1f2b50}
    .dev-left{display:flex;flex-direction:column}
    .dev-id{font-weight:600}
    .small{font-size:12px;color:var(--muted)}
    .controls{display:flex;gap:8px;align-items:center}
    .age{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; color:#cfd5e6; font-size:12px}

    /* NBIRTH panel */
    .nbirth { margin-top:12px; border-radius:10px; padding:0; border:1px solid #243366; background:#07102a; overflow:hidden; }
    .nbirth-header { display:flex; justify-content:space-between; align-items:center; gap:8px; padding:10px 12px; position:sticky; top:0; background:#07102a; z-index:5; border-bottom:1px solid #12203a; }
    .nbirth-body { padding:12px; max-height:320px; overflow-y:auto; }
    .nbirth-body .muted { color:var(--muted); }
    .nbirth pre { white-space:pre-wrap; font-family: ui-monospace, Menlo, Consolas, monospace; font-size:12px; color:#cfe1ff; margin:6px 0 0; background:transparent; border:0; }

    /* nice scrollbar for NBIRTH panel */
    .nbirth-body::-webkit-scrollbar { width:8px; }
    .nbirth-body::-webkit-scrollbar-thumb { background-color:#2e3e6f; border-radius:6px; }
    .nbirth-body:hover::-webkit-scrollbar-thumb { background-color:#4d66b8; }

    .toggle-mini { padding:6px 10px; border-radius:8px; font-size:12px; background:#0f1730; border:1px solid #243366; cursor:pointer; color:var(--muted) }
    .toggle-mini:hover { color:var(--text) }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üöÅ Drone Flight Stats & Devices</h1>
    <div class="card">
      <div class="row">
        <div>
          <label for="droneId">Drone ID</label>
          <input id="droneId" placeholder="e.g. 123456789" />
        </div>
        <div>
          <label for="unit">Units</label>
          <select id="unit">
            <option value="hours" selected>Hours</option>
            <option value="seconds">Seconds</option>
          </select>
        </div>
        <div>
          <label for="start">Start (ISO, optional)</label>
          <input id="start" placeholder="2025-11-01T00:00:00Z" />
        </div>
        <div>
          <label for="end">End (ISO, optional)</label>
          <input id="end" placeholder="2025-11-07T00:00:00Z" />
        </div>
      </div>

      <div class="flex" style="margin-top:12px">
        <div class="controls">
          <button id="loadBtn" type="button">Load Stats</button>
          <button id="resetBtn" type="button">Reset</button>
          <button id="refreshDevicesBtn" type="button" title="Refresh online devices">Refresh Devices</button>
        </div>
        <div style="margin-left:auto">
          <span id="status" class="muted"></span>
        </div>
      </div>

      <div class="grid" style="margin-top:16px">
        <div class="stat">
          <div class="label">Total Flying</div>
          <div id="fhValue" class="value">‚Äî</div>
          <div id="fhMeta" class="muted">window: last 365 days</div>
        </div>

        <div class="stat">
          <div class="label">Landing Count</div>
          <div id="landValue" class="value">‚Äî</div>
          <div id="landMeta" class="muted">window: last 365 days</div>
        </div>

        <div class="stat">
          <div class="label">Crash / Hard-Landing</div>
          <div class="value">
            <span id="crashCount">‚Äî</span>
            <span id="crashBadge" class="pill">recent list below</span>
          </div>
          <div id="crashMeta" class="muted">window: last 365 days</div>
        </div>

        <div class="stat">
          <div class="label">Online Devices</div>
          <div class="value" id="onlineCount">‚Äî</div>
          <div class="small" id="onlineMeta">last refresh: ‚Äî</div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-top:18px">
        <div class="card" style="padding:0;">
          <div style="display:flex;justify-content:space-between;align-items:center;padding:12px">
            <div style="font-weight:700">Recent Crash / Hard-Landing Events</div>
            <div class="small">showing latest 25</div>
          </div>

          <div id="alarmList" class="list" style="margin-top:0;padding:12px"></div>

          <!-- NBIRTH info panel (scrollable) -->
          <div id="nbirthPanel" class="nbirth" aria-live="polite">
            <div class="nbirth-header">
              <div style="display:flex;align-items:center;gap:12px">
                <div style="font-weight:700">Device Info (NBIRTH)</div>
                <div id="nbirthSource" class="small muted">‚Äî</div>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <button id="nbirthToggleBtn" class="toggle-mini" type="button" aria-expanded="true">Collapse</button>
              </div>
            </div>

            <div id="nbirthBody" class="nbirth-body">
              <div id="nbirthSummary" class="small muted">No device selected. Click Load Stats for a drone.</div>
              <pre id="nbirthRaw" style="display:none"></pre>
            </div>
          </div>

        </div>

        <div class="card" style="padding:12px;">
          <div style="font-weight:700;margin-bottom:8px">Online Devices</div>
          <div id="devices" class="devices small">
            <div class="muted">No data yet. Click 'Refresh Devices' or load stats.</div>
          </div>
        </div>
      </div>

      <div id="error" class="err" style="margin-top:12px"></div>
      <div class="footer">
        Uses <code>/flight-hours</code>, <code>/landings</code>, <code>/crash-alarms</code>, <code>/crash-alarms/count</code>, <code>/nbirth</code> and <code>/online-devices</code>.
      </div>
    </div>
  </div>

  <script>
    // helpers
    const $ = id => document.getElementById(id);
    const base = ""; // same-origin; change if your API sits under a prefix like "/api"

    function qs(params) {
      return Object.entries(params)
        .filter(([,v]) => v !== undefined && v !== null && String(v).trim() !== "")
        .map(([k,v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`)
        .join("&");
    }

    async function fetchJSON(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    function fmt(val, unit) {
      if (val === null || val === undefined || isNaN(val)) return "‚Äî";
      if (unit === "hours") return Number(val).toFixed(2) + " h";
      if (unit === "seconds") return Number(val).toFixed(0) + " s";
      return String(val);
    }

    // render alarms
    function renderAlarms(items) {
      const el = $("alarmList");
      el.innerHTML = "";
      if (!items || !items.length) {
        el.innerHTML = `<div class="item"><div class="muted">No crash/hard-landing events in window.</div></div>`;
        return;
      }
      items.slice(0,25).forEach(it => {
        const time = it.time || "";
        const event = it.event || "alarm";
        const vdown = it.v_down != null ? `v‚Üì ${Number(it.v_down).toFixed(2)} m/s` : "";
        const vh = it.v_h_pre != null ? `v‚Çï ${Number(it.v_h_pre).toFixed(2)} m/s` : "";
        const g = it.g != null ? `${Number(it.g).toFixed(1)} g` : "";
        const meta = [vdown, vh, g].filter(Boolean).join("  ¬∑  ");
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="muted">${time}</div>
          <div><span class="sev">${event.replace("_"," ")}</span></div>
          <div class="kv">${meta}</div>
        `;
        el.appendChild(div);
      });
    }

    // devices: sort by last_seen desc and show age (s)
    function ageSeconds(iso) {
      if (!iso) return null;
      const t = Date.parse(iso);
      if (isNaN(t)) return null;
      return Math.max(0, Math.floor((Date.now() - t) / 1000));
    }

    function renderDevices(items) {
      const el = $("devices");
      el.innerHTML = "";
      if (!items || !items.length) {
        el.innerHTML = `<div class="muted">No online devices.</div>`;
        $("onlineCount").textContent = "0";
        $("onlineMeta").textContent = `last refresh: ${new Date().toLocaleTimeString()}`;
        return;
      }

      // sort newest first (missing last_seen => push to end)
      items.sort((a,b) => {
        const ta = a.last_seen ? Date.parse(a.last_seen) : 0;
        const tb = b.last_seen ? Date.parse(b.last_seen) : 0;
        return (tb - ta);
      });

      items.forEach(it => {
        const div = document.createElement("div");
        div.className = "dev-item";
        const left = document.createElement("div");
        left.innerHTML = `<div class="dev-id">${it.drone_id}</div>
                          <div class="small">last_seen: ${it.last_seen || "‚Äî"}</div>`;
        const age = ageSeconds(it.last_seen);
        const right = document.createElement("div");
        right.innerHTML = `<div class="age">${age !== null ? age + " s" : "‚Äî"}</div>`;
        div.appendChild(left);
        div.appendChild(right);
        el.appendChild(div);
      });

      $("onlineCount").textContent = String(items.length);
      $("onlineMeta").textContent = `last refresh: ${new Date().toLocaleTimeString()}`;
    }

    // NBIRTH display helper
    function renderNBirth(resp) {
      const body = $("nbirthSummary");
      const raw = $("nbirthRaw");
      const src = $("nbirthSource");
      if (!resp || !resp.found) {
        src.textContent = "‚Äî";
        body.className = "small muted";
        body.textContent = "No NBIRTH found for this drone.";
        raw.style.display = "none";
        return;
      }

      src.textContent = `source: ${resp.source || "unknown"}`;
      const lines = [];
      if (resp.hostname) lines.push(`hostname: ${resp.hostname}`);
      if (resp.ip_address) lines.push(`ip: ${resp.ip_address}`);
      if (resp.last_seen) lines.push(`last_seen: ${resp.last_seen}`);
      if (resp.uptime_seconds != null) lines.push(`uptime_s: ${resp.uptime_seconds}`);
      if (resp.cpu_percent != null) lines.push(`cpu%: ${resp.cpu_percent}`);
      if (resp.mem_total_mb != null) lines.push(`mem_total_mb: ${resp.mem_total_mb}`);
      if (resp.mem_used_mb != null) lines.push(`mem_used_mb: ${resp.mem_used_mb}`);
      if (resp.mem_percent != null) lines.push(`mem%: ${resp.mem_percent}`);
      if (resp.deployments) lines.push(`deployments: (${Array.isArray(resp.deployments) ? resp.deployments.length : "?"})`);

      body.className = "small";
      body.innerHTML = lines.length ? lines.map(l => `<div>${l}</div>`).join("") : "<div class='muted'>No structured NBIRTH fields available.</div>";

      // show raw deployments JSON for convenience
      if (resp.deployments) {
        raw.style.display = "block";
        raw.textContent = JSON.stringify(resp.deployments, null, 2);
      } else {
        raw.style.display = "none";
      }
    }

    // Data loaders
    async function loadNBirth(droneId) {
      if (!droneId) return renderNBirth(null);
      const url = `${base}/nbirth?${qs({ drone_id: droneId })}`;
      try {
        const resp = await fetchJSON(url);
        renderNBirth(resp);
      } catch (e) {
        $("error").textContent = `Failed to load NBIRTH: ${e.message}`;
        renderNBirth(null);
      }
    }

    async function loadStats() {
      $("error").textContent = "";
      $("status").textContent = "Loading‚Ä¶";

      const droneId = $("droneId").value.trim();
      const unit = $("unit").value;
      const start = $("start").value.trim();
      const end = $("end").value.trim();

      if (!droneId) {
        $("error").textContent = "Please enter a drone ID.";
        $("status").textContent = "";
        return;
      }

      const qBase = { start, end };
      const fhURL = `${base}/flight-hours?${qs({ ...qBase, drone_id: droneId, unit })}`;
      const ldURL = `${base}/landings?${qs({ ...qBase, drone_id: droneId })}`;
      const caCntURL = `${base}/crash-alarms/count?${qs({ ...qBase, drone_id: droneId })}`;
      const caListURL = `${base}/crash-alarms?${qs({ ...qBase, drone_id: droneId })}`;
      const nbURL = `${base}/nbirth?${qs({ drone_id: droneId })}`;

      try {
        const [fh, ld, caCnt, caList, nb] = await Promise.all([
          fetchJSON(fhURL),
          fetchJSON(ldURL),
          fetchJSON(caCntURL),
          fetchJSON(caListURL),
          fetchJSON(nbURL)
        ]);

        $("fhValue").textContent = fmt(fh.value, unit);
        $("fhMeta").textContent = `window: ${fh.start} ‚Üí ${fh.end}`;

        $("landValue").textContent = (ld.landings ?? "‚Äî");
        $("landMeta").textContent = `window: ${ld.start} ‚Üí ${ld.end}`;

        $("crashCount").textContent = (caCnt.count ?? "‚Äî");
        $("crashMeta").textContent = `window: ${caList.start || fh.start} ‚Üí ${caList.end || fh.end}`;
        renderAlarms(caList.items);

        // render NBIRTH directly
        renderNBirth(nb);

        $("status").textContent = "Updated";
      } catch (e) {
        $("error").textContent = `Failed to load stats: ${e.message}`;
        $("status").textContent = "";
      }
    }

    async function loadDevices() {
      try {
        const url = `${base}/online-devices`;
        const res = await fetchJSON(url);
        const items = res.devices || [];
        renderDevices(items);
      } catch (e) {
        $("devices").innerHTML = `<div class="muted">Failed to load devices: ${e.message}</div>`;
        console.error("loadDevices error", e);
      }
    }

    // attach listeners after DOM ready
    document.addEventListener("DOMContentLoaded", () => {
      // wire buttons
      $("loadBtn").addEventListener("click", loadStats);
      $("resetBtn").addEventListener("click", () => {
        ["droneId","start","end"].forEach(id => $(id).value = "");
        ["fhValue","landValue","crashCount","onlineCount"].forEach(id => $(id).textContent = "‚Äî");
        ["fhMeta","landMeta","crashMeta","onlineMeta"].forEach(id => $(id).textContent = "window: last 365 days");
        $("alarmList").innerHTML = "";
        $("devices").innerHTML = `<div class="muted">No data yet. Click 'Refresh Devices' or load stats.</div>`;
        $("status").textContent = "";
        $("error").textContent = "";
        renderNBirth(null);
      });
      $("refreshDevicesBtn").addEventListener("click", loadDevices);

      // NBIRTH collapse/expand toggle
      const nbToggle = $("nbirthToggleBtn");
      const nbBody = $("nbirthBody");
      nbToggle.addEventListener("click", () => {
        const expanded = nbToggle.getAttribute("aria-expanded") === "true";
        if (expanded) {
          // collapse
          nbBody.style.display = "none";
          nbToggle.textContent = "Expand";
          nbToggle.setAttribute("aria-expanded", "false");
        } else {
          // expand
          nbBody.style.display = "";
          nbToggle.textContent = "Collapse";
          nbToggle.setAttribute("aria-expanded", "true");
        }
      });

      // auto-refresh devices every 20s
      let devicesInterval = null;
      function startAuto() {
        if (devicesInterval) clearInterval(devicesInterval);
        loadDevices();
        devicesInterval = setInterval(loadDevices, 20*1000);
      }
      startAuto();
      // initial NBIRTH panel empty
      renderNBirth(null);
    });
  </script>
</body>
</html>
